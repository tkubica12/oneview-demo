- name: Ensure that VLANs exist
  comware_vlan:
    state: "{{ state }}"
    vlanid: "{{ item.id }}"
    name: "{{ item.name }}"
    username: "{{ switch_username }}"
    password: "{{ switch_password }}"
    hostname: "{{ inventory_hostname }}"
  with_items: "{{ vlans }}"

- name: Ensure link aggregation is configured
  comware_portchannel:
    state: "{{ state }}"
    group: "{{ item.switch_link_aggregation_group }}"
    members: "{{ item.switchports }}"
    mode: dynamic
    type: bridged
    username: "{{ switch_username }}"
    password: "{{ switch_password }}"
    hostname: "{{ inventory_hostname }}"
  with_items: "{{ interconnect_modules }}"
  when: item.switch_link_aggregation_group is defined

- name: Create permited VLANs string
  set_fact:
    permitted_vlans: "{{ vlans | map(attribute='id') | join(',') }}"

- name: Ensure that VLANs are configured on standalone ports
  comware_switchport:
    state: "{{ state }}"
    name: "{{ item[1] }}"
    link_type: trunk
    permitted_vlans: "{{ permitted_vlans }}"
    username: "{{ switch_username }}"
    password: "{{ switch_password }}"
    hostname: "{{ inventory_hostname }}"
  with_subelements:
    - "{{ interconnect_modules }}"
    - switchports
  when: item[0].switch_link_aggregation_group is not defined

- name: Ensure that VLANs are configured on link aggregattion interfaces
  comware_switchport:
    state: "{{ state }}"
    name: "Bridge-Aggregation {{ item.switch_link_aggregation_group }}"
    link_type: trunk
    permitted_vlans: "{{ permitted_vlans }}"
    username: "{{ switch_username }}"
    password: "{{ switch_password }}"
    hostname: "{{ inventory_hostname }}"
  with_items: "{{ interconnect_modules }}"
  when: item.switch_link_aggregation_group is defined

- name: Save switch configuration
  comware_save:
      username: "{{ switch_username }}"
      password: "{{ switch_password }}"
      hostname: "{{ inventory_hostname }}"
